---
phase: 02-tab-shell-analytics
plan: 03
type: execute
wave: 3
depends_on: [02-01, 02-02]
files_modified:
  - src/components/ftc/analytics/EnforcementByYear.tsx
  - src/components/ftc/analytics/EnforcementByAdmin.tsx
autonomous: true
requirements: [ANLY-01, ANLY-02, ANLY-04]

must_haves:
  truths:
    - "A stacked bar chart shows enforcement action counts by year with violation type breakdown"
    - "A reference table below the year chart shows year, case count, top statutes, and notable cases with expandable rows"
    - "A grouped/stacked bar chart shows enforcement counts by administration with topic breakdown"
    - "A reference table below the admin chart shows side-by-side administration comparison data"
    - "Clicking a table row expands inline to show the matching case list"
    - "Chart tooltips use law-library styling (EB Garamond, cream background, rule border)"
  artifacts:
    - path: "src/components/ftc/analytics/EnforcementByYear.tsx"
      provides: "Year-by-year enforcement chart + expandable reference table"
      exports: ["default"]
    - path: "src/components/ftc/analytics/EnforcementByAdmin.tsx"
      provides: "Administration enforcement chart with topic breakdown + expandable reference table"
      exports: ["default"]
  key_links:
    - from: "src/components/ftc/analytics/EnforcementByYear.tsx"
      to: "recharts"
      via: "BarChart with stacked bars"
      pattern: "import.*BarChart.*from.*recharts"
    - from: "src/components/ftc/analytics/EnforcementByYear.tsx"
      to: "src/components/ftc/analytics/ReferenceTable.tsx"
      via: "expandable reference table below chart"
      pattern: "import ReferenceTable"
    - from: "src/components/ftc/analytics/EnforcementByAdmin.tsx"
      to: "recharts"
      via: "BarChart with grouped bars"
      pattern: "import.*BarChart.*from.*recharts"
    - from: "src/components/ftc/analytics/EnforcementByAdmin.tsx"
      to: "src/components/ftc/analytics/ReferenceTable.tsx"
      via: "expandable reference table below chart"
      pattern: "import ReferenceTable"
---

<objective>
Build the Enforcement by Year and Enforcement by Administration chart+table sections for the Analytics tab.

Purpose: These are the first two analytics sections users see — enforcement volume over time and how enforcement varies across presidential administrations. They replace the existing year/administration grouping views with richer dedicated chart+table sections.

Output: EnforcementByYear.tsx and EnforcementByAdmin.tsx, each rendering a Recharts chart with an expandable ReferenceTable below it.
</objective>

<execution_context>
@C:/Users/rafst/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rafst/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tab-shell-analytics/02-CONTEXT.md
@.planning/phases/02-tab-shell-analytics/02-RESEARCH.md
@.planning/phases/02-tab-shell-analytics/02-01-SUMMARY.md
@.planning/phases/02-tab-shell-analytics/02-02-SUMMARY.md
@src/components/ftc/FTCGroupChart.tsx
@src/components/ftc/analytics/ReferenceTable.tsx
@src/types/ftc.ts
@src/constants/ftc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EnforcementByYear chart + reference table section</name>
  <files>
    src/components/ftc/analytics/EnforcementByYear.tsx
  </files>
  <action>
    Create EnforcementByYear.tsx:

    Props: { data: FTCDataPayload }

    Section structure:
    - Wrapper div with id="enforcement-by-year" (for sidebar anchor navigation)
    - Section heading: "Enforcement Actions by Year" in text-xl font-semibold text-primary
    - Brief description: 1 sentence explaining what this section shows
    - Chart container + ReferenceTable below

    Chart (Recharts stacked BarChart):
    - Use data.groupings.by_year for chart data
    - Transform to chartData array: { name: year, deceptive: count, unfair: count, both: count }
    - Stacked bars with stackId="a" for violation type breakdown (same pattern as existing FTCGroupChart year mode)
    - Colors: use same COLORS object as FTCGroupChart (deceptive: hsl(35, 85%, 50%), unfair: hsl(0, 65%, 50%), both: hsl(158, 60%, 35%))
    - Tooltip with law-library styling: background cream, border rule, borderRadius 0, fontFamily EB Garamond
    - Legend below chart
    - Wrap in div.w-full.h-[350px] > ResponsiveContainer
    - XAxis: dataKey="name", fontSize 11, tick interval 1 (show every other year)
    - YAxis: fontSize 12

    Reference table:
    - Import and use ReferenceTable component from ./ReferenceTable
    - Headers: ["Year", "Cases", "Violation Breakdown", "Top Categories"]
    - Compute rows from data using useMemo:
      - For each year group in data.groupings.by_year:
        - key: year string
        - cells: [year, count, "D:{deceptive} U:{unfair} B:{both}" formatted string, top_categories joined]
        - expandedContent: render a mini case list showing cases for that year
    - For expandedContent: filter data.cases by year, render a compact list (ul) showing company_name, date_issued, violation_type, docket_number for each case
    - Style the expanded case list: text-sm, space-y-1, each case as a flex row with company name bolded and date/docket in muted color

    Wrap all derived data computations in useMemo with [data] dependency.
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero TypeScript errors.
    Component renders stacked bar chart and reference table with expandable year rows.
  </verify>
  <done>
    EnforcementByYear.tsx renders a stacked bar chart showing enforcement counts by year with violation type breakdown. Below the chart, a ReferenceTable shows year details with clickable rows that expand to show the matching cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EnforcementByAdmin chart + reference table section</name>
  <files>
    src/components/ftc/analytics/EnforcementByAdmin.tsx
  </files>
  <action>
    Create EnforcementByAdmin.tsx — this satisfies both ANLY-02 (admin enforcement trends) and ANLY-04 (admin comparison side-by-side) as a single combined section per research recommendation.

    Props: { data: FTCDataPayload }

    Section structure:
    - Wrapper div with id="enforcement-by-admin" (for sidebar anchor)
    - Section heading: "Enforcement by Presidential Administration"
    - Brief description explaining this section compares enforcement patterns across administrations

    Chart (Recharts grouped BarChart):
    - Compute adminData using useMemo from data.groupings.by_administration:
      - For each admin: { name: label, total: count, deceptive: vb.deceptive, unfair: vb.unfair, both: vb.both }
      - Also compute statutory_topic breakdown per admin: for each admin, filter data.cases by administration, count cases per statutory topic
    - Use horizontal BarChart (layout="vertical") since administration labels are long
    - Show stacked bars for violation type breakdown (deceptive/unfair/both) per admin
    - Same COLORS as year chart for consistency
    - Height: dynamic based on number of administrations (Math.max(300, admins.length * 60))
    - Tooltip and axis styling matching law-library aesthetic

    Reference table (administration comparison):
    - Headers: ["Administration", "Cases", "Deceptive", "Unfair", "Both", "Top Topics"]
    - For each admin group:
      - Compute top statutory topics: from filtered cases, count occurrences of each statutory_topic, show top 3
      - cells: [admin name, total count, deceptive count, unfair count, both count, top topics comma-separated]
      - expandedContent: render cases for that administration with company_name, year, violation_type, docket_number
    - This table IS the side-by-side comparison view (ANLY-04) — all administrations visible in one table with consistent columns

    All data computations wrapped in useMemo with [data] dependency.
    Cast cases as EnhancedFTCCaseSummary to access statutory_topics field (import from @/types/ftc).
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero TypeScript errors.
    Component renders horizontal stacked bar chart and reference table with expandable admin rows.
  </verify>
  <done>
    EnforcementByAdmin.tsx renders a horizontal stacked bar chart showing enforcement by administration with violation breakdown. Below, a reference table shows side-by-side administration comparison with case counts, violation breakdown, and top statutory topics. Rows expand to show matching cases.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. EnforcementByYear renders stacked bar chart + expandable table for 28 year groups
3. EnforcementByAdmin renders horizontal bar chart + expandable table for 6 administrations
4. Both tables have clickable rows that expand inline with case lists
5. Charts use law-library tooltip styling (cream, EB Garamond, no border-radius)
6. All data derivations use useMemo
7. Section wrapper divs have correct id attributes for sidebar anchor navigation
</verification>

<success_criteria>
- Two chart+table sections compile and render with real FTC data
- Charts reuse proven Recharts patterns from existing FTCGroupChart
- Reference tables use the shared ReferenceTable component with expandable rows
- Administration comparison (ANLY-04) is integrated into the admin section table
- Sections have anchor IDs for sidebar navigation
</success_criteria>

<output>
After completion, create `.planning/phases/02-tab-shell-analytics/02-03-SUMMARY.md`
</output>
