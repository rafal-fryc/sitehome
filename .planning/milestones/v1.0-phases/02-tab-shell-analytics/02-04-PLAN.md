---
phase: 02-tab-shell-analytics
plan: 04
type: execute
wave: 3
depends_on: [02-01, 02-02]
files_modified:
  - src/components/ftc/analytics/TopicTrendLines.tsx
  - src/components/ftc/analytics/ProvisionAnalytics.tsx
  - src/components/ftc/analytics/ViolationBreakdown.tsx
autonomous: true
requirements: [ANLY-03, ANLY-08]

must_haves:
  truths:
    - "Multi-line chart shows how enforcement focus shifts across statutory topics over time"
    - "Each statutory topic is a separate colored line on the chart"
    - "A reference table below the topic chart shows year-by-topic case counts with expandable rows"
    - "Provision-level analytics show counts by remedy type and by topic"
    - "Violation type breakdown (deceptive vs unfair vs both) is preserved from existing analytics"
    - "Years with zero cases for a topic show 0 (not missing data) so lines are continuous"
  artifacts:
    - path: "src/components/ftc/analytics/TopicTrendLines.tsx"
      provides: "Multi-line topic-over-time trend chart + reference table"
      exports: ["default"]
    - path: "src/components/ftc/analytics/ProvisionAnalytics.tsx"
      provides: "Provision-level counts by remedy type and topic"
      exports: ["default"]
    - path: "src/components/ftc/analytics/ViolationBreakdown.tsx"
      provides: "Refactored violation type donut from existing ViolationDonut"
      exports: ["default"]
  key_links:
    - from: "src/components/ftc/analytics/TopicTrendLines.tsx"
      to: "recharts"
      via: "LineChart with multiple Line series"
      pattern: "import.*LineChart.*Line.*from.*recharts"
    - from: "src/components/ftc/analytics/TopicTrendLines.tsx"
      to: "src/components/ftc/analytics/ReferenceTable.tsx"
      via: "expandable reference table"
      pattern: "import ReferenceTable"
    - from: "src/components/ftc/analytics/ProvisionAnalytics.tsx"
      to: "recharts"
      via: "BarChart for remedy type and topic counts"
      pattern: "import.*BarChart.*from.*recharts"
---

<objective>
Build the Topic Trend Lines, Provision Analytics, and Violation Breakdown chart+table sections for the Analytics tab.

Purpose: Topic trend lines (ANLY-03) are the key new analytics feature — showing how FTC enforcement focus has shifted across statutory topics over time. Provision analytics (ANLY-08) add a new dimension by showing remedy type and topic distributions at the provision level. Violation breakdown preserves existing functionality.

Output: TopicTrendLines.tsx, ProvisionAnalytics.tsx, ViolationBreakdown.tsx — each rendering chart(s) with reference tables.
</objective>

<execution_context>
@C:/Users/rafst/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rafst/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tab-shell-analytics/02-CONTEXT.md
@.planning/phases/02-tab-shell-analytics/02-RESEARCH.md
@.planning/phases/02-tab-shell-analytics/02-01-SUMMARY.md
@.planning/phases/02-tab-shell-analytics/02-02-SUMMARY.md
@src/components/ftc/FTCGroupChart.tsx
@src/components/ftc/analytics/ReferenceTable.tsx
@src/types/ftc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TopicTrendLines multi-line chart + reference table</name>
  <files>
    src/components/ftc/analytics/TopicTrendLines.tsx
  </files>
  <action>
    Create TopicTrendLines.tsx:

    Props: { data: FTCDataPayload }

    Section structure:
    - Wrapper div with id="topic-trends" (for sidebar anchor)
    - Section heading: "Enforcement Focus by Statutory Topic"
    - Brief description: "How enforcement attention has shifted across statutory topics over time"

    Topic color palette (within law-library palette constraints):
    ```typescript
    const TOPIC_COLORS: Record<string, string> = {
      "COPPA": "hsl(158, 80%, 25%)",
      "FCRA": "hsl(45, 85%, 45%)",
      "GLBA": "hsl(158, 60%, 40%)",
      "Health Breach Notification": "hsl(20, 70%, 50%)",
      "Section 5 Only": "hsl(158, 30%, 55%)",
      "TSR": "hsl(45, 60%, 60%)",
      "CAN-SPAM": "hsl(200, 40%, 45%)",
      "TCPA": "hsl(340, 50%, 45%)",
    };
    ```

    Chart data computation (useMemo):
    - Get all unique years from data.cases, sorted ascending
    - Define TOPICS array: all StatutoryTopic values
    - Cast cases as EnhancedFTCCaseSummary to access statutory_topics field
    - For each year: create data point object with { year: String(year) }
    - For each topic: count cases in that year where statutory_topics includes the topic
    - IMPORTANT: Always include 0 for years with no cases for a topic (prevents misleading line jumps)
    - Result: array of { year, COPPA: n, FCRA: n, ... }

    Chart (Recharts LineChart):
    - Wrap in div.w-full.h-[400px] > ResponsiveContainer
    - CartesianGrid with strokeDasharray="3 3" stroke="hsl(50, 15%, 85%)"
    - XAxis dataKey="year", fontSize 11, tick interval 2 (show every 3rd year)
    - YAxis fontSize 12
    - Tooltip with law-library styling
    - Legend
    - For each topic in TOPIC_COLORS: render a Line component with type="monotone", dataKey={topic}, stroke={color}, strokeWidth=2, dot={{ r: 3 }}, activeDot={{ r: 5 }}

    Reference table:
    - Headers: ["Year", ...TOPICS] (one column per topic)
    - For each year: cells show the case count for each topic
    - expandedContent: list of cases in that year, showing company_name, statutory_topics joined, violation_type
    - For wide tables: wrap in a div with overflow-x-auto

    All computations in useMemo with [data] dependency.
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero TypeScript errors.
    Component renders multi-line chart with one line per statutory topic and reference table below.
  </verify>
  <done>
    TopicTrendLines.tsx renders a multi-line Recharts LineChart showing enforcement focus by statutory topic over time. Each topic has a distinct colored line. Reference table shows year-by-topic breakdown with expandable rows. Zero-count years show explicit 0 values for continuous lines.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProvisionAnalytics and ViolationBreakdown sections</name>
  <files>
    src/components/ftc/analytics/ProvisionAnalytics.tsx
    src/components/ftc/analytics/ViolationBreakdown.tsx
  </files>
  <action>
    Create ProvisionAnalytics.tsx:

    Props: { data: FTCDataPayload }

    Section structure:
    - Wrapper div with id="provision-analytics" (for sidebar anchor)
    - Section heading: "Provision-Level Analytics"
    - Brief description: "Distribution of consent order provisions by remedy type and topic"

    Data computation (useMemo, cast cases as EnhancedFTCCaseSummary):
    1. Remedy type aggregation: sum remedy_types across all cases
       - For each case, for each remedy_type in case.remedy_types, increment count
       - Result: Record<string, number> of remedy type -> total case count
    2. Topic provision count aggregation: sum provision_counts_by_topic across all cases
       - For each case, for each [topic, count] in provision_counts_by_topic, add count
       - Result: Record<string, number> of topic -> total provision count

    Chart 1: Horizontal bar chart of remedy type counts
    - Sort by count descending
    - Transform to chartData: { name: remedyType, count: number }
    - Horizontal BarChart (layout="vertical"), height based on number of remedy types
    - Bar fill: alternating hsl(158, 60%, 35%) and hsl(45, 85%, 55%)
    - Tooltip with law-library styling

    Chart 2: Horizontal bar chart of provisions by topic
    - Sort by count descending
    - Same horizontal bar pattern as remedy type chart
    - Different section: "Provisions by Statutory Topic"

    Reference table for each chart:
    - Remedy types table: Headers ["Remedy Type", "Cases"], rows from aggregation, no expanded content needed (simple counts)
    - Topic provisions table: Headers ["Topic", "Provisions"], rows from aggregation, no expanded content needed

    ---

    Create ViolationBreakdown.tsx:

    Props: { data: FTCDataPayload }

    Section structure:
    - Wrapper div with id="violation-breakdown" (for sidebar anchor)
    - Section heading: "Violation Type Breakdown"

    This is a refactored version of the existing ViolationDonut (from FTCGroupChart.tsx):
    - Same PieChart/donut logic: compute deceptive, unfair, both counts from data.cases
    - Same COLORS and visual style
    - Add a simple reference table below the donut: Headers ["Type", "Count", "Percentage"]
    - Compute percentage for each type
    - No expanded content needed (3 rows total)

    This preserves ANLY-07 functionality while fitting into the new analytics section pattern.
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero TypeScript errors.
    ProvisionAnalytics renders two horizontal bar charts with tables.
    ViolationBreakdown renders donut chart with summary table.
  </verify>
  <done>
    ProvisionAnalytics.tsx renders provision-level analytics with remedy type and topic distribution charts + tables. ViolationBreakdown.tsx renders the existing violation donut with an added reference table. All sections have anchor IDs and law-library styling.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. TopicTrendLines renders multi-line chart with 8 topic lines and reference table
3. ProvisionAnalytics renders two horizontal bar charts with summary tables
4. ViolationBreakdown renders donut + table preserving existing functionality
5. All sections have correct id attributes for sidebar navigation
6. Chart tooltips use law-library styling
7. All data computations wrapped in useMemo
8. No missing data points in topic trend lines (explicit 0 values)
</verification>

<success_criteria>
- Topic trend lines show enforcement focus shifts over time
- Provision analytics show remedy type and topic distributions
- Violation breakdown is preserved from existing analytics
- All three components compile and render with real FTC data
- Sections ready for integration into the Analytics tab layout
</success_criteria>

<output>
After completion, create `.planning/phases/02-tab-shell-analytics/02-04-SUMMARY.md`
</output>
