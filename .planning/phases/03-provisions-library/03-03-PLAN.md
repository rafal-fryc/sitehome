---
phase: 03-provisions-library
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/ftc/provisions/ProvisionFilterBar.tsx
  - src/components/ftc/provisions/FilterChips.tsx
  - src/components/ftc/provisions/CompanyAutocomplete.tsx
  - src/components/ftc/provisions/ProvisionsContent.tsx
  - src/constants/ftc.ts
autonomous: true
requirements:
  - PROV-05
  - PROV-06
  - PROV-07
  - PROV-08
  - PROV-10

must_haves:
  truths:
    - "User can filter provisions by date range using preset period buttons (Last 5 years, Obama era, Trump era, Biden era) plus a custom range option"
    - "User can filter provisions by company name using a type-ahead search/autocomplete input"
    - "User can filter provisions by remedy type using a multi-select control"
    - "User can sort provisions by date, company, or provision type"
    - "Active filters are shown as dismissible chips below the filter bar with a Clear all button"
    - "Provision count updates to reflect filtered results (e.g., Showing 12 of 451 provisions)"
  artifacts:
    - path: "src/components/ftc/provisions/ProvisionFilterBar.tsx"
      provides: "Sticky filter bar with date presets, company autocomplete, remedy type filter, sort, and search placeholder"
    - path: "src/components/ftc/provisions/FilterChips.tsx"
      provides: "Active filter chip display with dismiss and clear all"
    - path: "src/components/ftc/provisions/CompanyAutocomplete.tsx"
      provides: "Company name typeahead using cmdk Command + Popover"
    - path: "src/constants/ftc.ts"
      provides: "DATE_PRESETS constant for date range filter"
  key_links:
    - from: "src/components/ftc/provisions/ProvisionsContent.tsx"
      to: "src/components/ftc/provisions/ProvisionFilterBar.tsx"
      via: "renders filter bar and passes filter state + callbacks"
      pattern: "ProvisionFilterBar"
    - from: "src/components/ftc/provisions/ProvisionFilterBar.tsx"
      to: "src/components/ftc/provisions/CompanyAutocomplete.tsx"
      via: "renders company autocomplete within filter bar"
      pattern: "CompanyAutocomplete"
    - from: "src/components/ftc/provisions/ProvisionsContent.tsx"
      to: "date-fns"
      via: "uses parseISO and isWithinInterval for date filtering"
      pattern: "isWithinInterval|parseISO"
---

<objective>
Add filtering (date range, company name, remedy type), sorting, and active filter chips to the provisions content area.

Purpose: Legal practitioners need to narrow results within a topic to find specific provisions quickly. Date range filtering enables era-based research (e.g., "Obama era COPPA enforcement"), company filtering enables case-specific research, and remedy type filtering enables cross-cutting analysis within a topic.

Output: Sticky filter bar with all filter controls, company autocomplete, filter chips, sort controls
</objective>

<execution_context>
@C:/Users/rafst/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rafst/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-provisions-library/03-RESEARCH.md
@.planning/phases/03-provisions-library/03-02-SUMMARY.md
@src/components/ftc/provisions/ProvisionsContent.tsx
@src/types/ftc.ts
@src/constants/ftc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filter bar components (date presets, company autocomplete, remedy type filter, sort, chips)</name>
  <files>
    src/constants/ftc.ts
    src/components/ftc/provisions/CompanyAutocomplete.tsx
    src/components/ftc/provisions/FilterChips.tsx
    src/components/ftc/provisions/ProvisionFilterBar.tsx
  </files>
  <action>
1. Add `DATE_PRESETS` constant to `src/constants/ftc.ts`:
   ```typescript
   export const DATE_PRESETS = [
     { label: "Last 5 years", start: "2021-01-01", end: "2026-12-31" },
     { label: "Obama era", start: "2009-01-20", end: "2017-01-20" },
     { label: "Trump era", start: "2017-01-20", end: "2021-01-20" },
     { label: "Biden era", start: "2021-01-20", end: "2025-01-20" },
   ] as const;
   ```
   Also add `REMEDY_TYPE_OPTIONS` array listing all 10 RemedyType values for the filter dropdown.

2. Create `src/components/ftc/provisions/CompanyAutocomplete.tsx`:
   - Uses shadcn/ui Popover + Command (cmdk) pattern — same as established combobox pattern
   - Props: `companies: string[]` (sorted unique company names), `selectedCompany: string | null`, `onSelect: (company: string | null) => void`
   - Trigger button shows selected company name or "Company..." placeholder
   - CommandInput with placeholder "Search company..."
   - CommandList with CommandEmpty ("No company found.")
   - CommandItem for each company — onSelect sets the company and closes popover
   - Styled with law-library aesthetic (font-garamond, border-rule)

3. Create `src/components/ftc/provisions/FilterChips.tsx`:
   - Props: `filters: { key: string; label: string; value: string }[]`, `onDismiss: (key: string) => void`, `onClearAll: () => void`
   - Renders only when filters array is non-empty
   - Each chip: `inline-flex items-center gap-1 px-2 py-0.5 text-sm border border-rule bg-cream font-garamond`
   - Dismiss button with X icon (lucide-react X icon, 14px)
   - "Clear all" button at the end if more than one active filter
   - Display format: "{value} x" (e.g., "2020-2025 x", "Facebook x", "Data Deletion x")

4. Create `src/components/ftc/provisions/ProvisionFilterBar.tsx`:
   - Sticky bar: `sticky top-0 z-10 bg-background border-b border-rule py-3 space-y-2`
   - Props interface for all filter state and callbacks:
     ```typescript
     interface Props {
       activeDateRange: string | null;
       onDateRange: (preset: string | null, start: string, end: string) => void;
       companies: string[];
       selectedCompany: string | null;
       onCompanyFilter: (company: string | null) => void;
       selectedRemedyTypes: string[];
       onRemedyTypeFilter: (types: string[]) => void;
       sortKey: "date" | "company" | "type";
       sortDir: "asc" | "desc";
       onSort: (key: "date" | "company" | "type") => void;
       resultCount: number;
       totalCount: number;
       caseCount: number;
       activeFilters: { key: string; label: string; value: string }[];
       onDismissFilter: (key: string) => void;
       onClearAll: () => void;
     }
     ```
   - Layout: flex flex-wrap items-center gap-3
     - Date range preset buttons (per user decision): "Last 5 years", "Obama era", "Trump era", "Biden era" — styled as small toggle buttons, active one gets primary bg
     - CompanyAutocomplete component
     - Remedy type filter: shadcn/ui Select with multi-select behavior (or Popover with checkboxes for multi-select since shadcn Select is single-select). Use Popover + checkbox list pattern for multi-select. Each checked remedy type is added/removed from the selectedRemedyTypes array.
     - Sort control: small dropdown/select with options "Date", "Company", "Type" — toggling the same sort key flips direction (asc/desc). Display a sort direction arrow icon.
     - Result count: "Showing {resultCount} of {totalCount} provisions from {caseCount} cases" (text-sm text-muted-foreground, ml-auto)
   - Below the controls row: `<FilterChips>` component showing active filters
   - Leave a placeholder slot for the search input (will be added in Plan 04)
  </action>
  <verify>
- All four files compile without TypeScript errors
- ProvisionFilterBar renders date preset buttons, company autocomplete, remedy type filter, sort control, and result count
- FilterChips renders dismissible chips for active filters
- CompanyAutocomplete opens a popover with company search
  </verify>
  <done>
- Date preset buttons are rendered and styled
- Company autocomplete uses cmdk + Popover pattern
- Remedy type multi-select filter is functional
- Sort control toggles between date/company/type with direction
- Active filters display as dismissible chips with "Clear all"
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate filter bar into ProvisionsContent with client-side filtering and sorting</name>
  <files>
    src/components/ftc/provisions/ProvisionsContent.tsx
  </files>
  <action>
1. Update `ProvisionsContent.tsx` to add filter/sort state management:
   - Add state for: `activeDateRange` (string | null for preset label), `dateStart`/`dateEnd` (string | null), `selectedCompany` (string | null), `selectedRemedyTypes` (string[]), `sortKey` ("date" | "company" | "type"), `sortDir` ("asc" | "desc")
   - Default sort: date descending (most recent first)
   - Reset page to 1 when any filter changes

2. Derive filtered + sorted provisions using `useMemo`:
   - Start with all provisions from the loaded shard
   - **Date range filter** (PROV-05): If dateStart and dateEnd are set, filter using `date-fns` `parseISO` and `isWithinInterval`. Import from "date-fns".
   - **Company filter** (PROV-06): If selectedCompany is set, filter where `provision.company_name === selectedCompany`
   - **Remedy type filter** (PROV-07): If selectedRemedyTypes is non-empty, filter where provision has at least one matching remedy type (`provision.remedy_types.some(rt => selectedRemedyTypes.includes(rt))`)
   - **Sort** (PROV-08): Sort by sortKey:
     - "date": compare by `date_issued` string (ISO format, lexicographic comparison works)
     - "company": compare by `company_name` locale string comparison
     - "type": compare by `category` string
     - Apply sortDir (asc/desc)

3. Compute derived values for the filter bar:
   - `companies`: sorted unique company names from the FULL shard data (not filtered) — using `useMemo`
   - `resultCount`: filtered provisions length
   - `totalCount`: total provisions in shard
   - `caseCount`: unique case_ids in filtered provisions
   - `activeFilters` array: build from current filter state for FilterChips display

4. Render ProvisionFilterBar above the provision card list:
   - Position between disclaimer banner and provision cards
   - Pass all filter state and callbacks
   - Filter dismiss handler: reset the corresponding filter state
   - Clear all handler: reset all filters to defaults

5. Paginate the FILTERED results (not the raw shard data):
   - Maintain page state, reset to 1 on any filter/sort change
   - Slice filtered provisions for current page (50 per page)

6. Update the result count display in the provision count area to show filtered counts (PROV-10):
   - "Showing {pageStart}-{pageEnd} of {filteredCount} provisions from {filteredCaseCount} cases"
   - If filters are active, additionally show "(filtered from {totalCount} total)"
  </action>
  <verify>
- Navigate to `/FTCAnalytics?tab=provisions&topic=coppa`
- Click "Obama era" date preset — provision list filters to 2009-2017 range, count updates
- Type a company name in autocomplete — matching company's provisions show
- Select a remedy type — provisions filter to those with matching remedy type
- Click sort by Company — provisions reorder alphabetically by company name
- Active filter chips appear below filter bar; dismiss one to remove that filter
- Click "Clear all" to reset all filters
- Pagination reflects filtered count
  </verify>
  <done>
- Date range filter with preset buttons filters provisions by era (PROV-05)
- Company autocomplete filter narrows to specific company's provisions (PROV-06)
- Remedy type multi-select filters by remedy type (PROV-07)
- Sort control reorders by date, company, or provision type (PROV-08)
- Active filter chips are dismissible, "Clear all" resets everything
- Result count accurately reflects filtered and total counts (PROV-10)
  </done>
</task>

</tasks>

<verification>
- All filter controls are visible and functional in the sticky filter bar
- Date range presets filter correctly (verify "Obama era" shows only 2009-2017 provisions)
- Company autocomplete suggests matching names and filters on selection
- Remedy type filter narrows provisions to matching remedy types
- Sort changes the order of provision cards
- Filter chips appear and are dismissible
- Result count updates dynamically with each filter change
- Pagination works correctly with filtered data
</verification>

<success_criteria>
Legal practitioners can filter provisions within any topic by date range, company name, and remedy type, and sort results by date, company, or provision type. Active filters are visible as chips and easily dismissible.
</success_criteria>

<output>
After completion, create `.planning/phases/03-provisions-library/03-03-SUMMARY.md`
</output>
