---
phase: 03-provisions-library
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - src/hooks/use-provision-search.ts
  - src/components/ftc/provisions/HighlightText.tsx
  - src/components/ftc/provisions/SearchResults.tsx
  - src/components/ftc/provisions/ProvisionFilterBar.tsx
  - src/components/ftc/provisions/ProvisionsContent.tsx
  - src/components/ftc/provisions/ProvisionCard.tsx
  - src/components/ftc/FTCProvisionsTab.tsx
  - src/hooks/use-provisions.ts
autonomous: true
requirements:
  - PROV-09
  - PROV-10

must_haves:
  truths:
    - "User can type a search query in the filter bar and see matching provisions with highlighted terms"
    - "User can toggle search scope between This topic and All topics"
    - "Cross-topic search results are grouped by topic with counts per topic"
    - "Search results display total count of matching provisions and cases"
    - "Matching terms are highlighted within provision text"
  artifacts:
    - path: "src/hooks/use-provision-search.ts"
      provides: "MiniSearch index management hook"
    - path: "src/components/ftc/provisions/HighlightText.tsx"
      provides: "Text highlighting for search matches"
    - path: "src/components/ftc/provisions/SearchResults.tsx"
      provides: "Cross-topic search results grouped by topic"
  key_links:
    - from: "src/hooks/use-provision-search.ts"
      to: "minisearch"
      via: "imports MiniSearch and builds index from provisions"
      pattern: "import MiniSearch"
    - from: "src/components/ftc/provisions/ProvisionsContent.tsx"
      to: "src/hooks/use-provision-search.ts"
      via: "uses search hook for in-topic search"
      pattern: "useProvisionSearch"
    - from: "src/components/ftc/FTCProvisionsTab.tsx"
      to: "src/components/ftc/provisions/SearchResults.tsx"
      via: "renders cross-topic search results when search scope is All topics"
      pattern: "SearchResults"
---

<objective>
Add full-text search using MiniSearch with scope toggle (This topic / All topics), search term highlighting in provision text, and cross-topic search results view grouped by topic.

Purpose: Legal practitioners often need to find specific provision language across all consent orders (e.g., "comprehensive security program" or "algorithmic destruction"). Full-text search with ranking enables rapid discovery of relevant provisions. The scope toggle lets users search within the current topic or across all topics.

Output: MiniSearch integration, search input in filter bar, scope toggle, highlight component, cross-topic results view
</objective>

<execution_context>
@C:/Users/rafst/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rafst/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-provisions-library/03-RESEARCH.md
@.planning/phases/03-provisions-library/03-03-SUMMARY.md
@src/hooks/use-provisions.ts
@src/components/ftc/provisions/ProvisionFilterBar.tsx
@src/components/ftc/provisions/ProvisionsContent.tsx
@src/components/ftc/provisions/ProvisionCard.tsx
@src/components/ftc/FTCProvisionsTab.tsx
@src/types/ftc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MiniSearch, create search hook and highlight component</name>
  <files>
    src/hooks/use-provision-search.ts
    src/components/ftc/provisions/HighlightText.tsx
  </files>
  <action>
1. Install MiniSearch:
   ```bash
   npm install minisearch
   ```

2. Create `src/hooks/use-provision-search.ts`:
   - Import MiniSearch from "minisearch"
   - Export `useProvisionSearch(provisions: ProvisionRecord[])`:
     - Build a MiniSearch index inside `useMemo` with provisions as dependency
     - Fields to index: `["title", "summary", "verbatim_text"]`
     - Store fields: `["case_id", "company_name", "provision_number", "statutory_topics", "practice_areas"]`
     - idField: `"id"` — create composite ID `${p.case_id}__${p.provision_number}` for each document
     - Search options: `{ boost: { title: 2, verbatim_text: 1 }, prefix: true, fuzzy: 0.2 }`
     - Return an object: `{ search: (query: string, topicFilter?: string) => SearchResult[], miniSearch }`
     - The `search` function wraps `miniSearch.search(query, { filter: ... })`:
       - If `topicFilter` is provided, filter results to provisions matching that topic slug
       - Returns array of MiniSearch result objects (with id, score, match info)
   - Export `useAllProvisionsForSearch()`:
     - Uses `useQueries` from React Query to fetch ALL shard files in parallel
     - Gets the manifest first via `useProvisionsManifest()`
     - Returns `{ allProvisions: ProvisionRecord[], isLoading: boolean, loadedCount: number, totalCount: number }`
     - All provisions are flattened from all shard results into a single array (deduplicated by composite id `case_id__provision_number` since provisions can appear in multiple shards)

3. Create `src/components/ftc/provisions/HighlightText.tsx`:
   - Props: `{ text: string; query?: string; className?: string }`
   - If no query or empty query, return `<span className={className}>{text}</span>`
   - Split text at query match boundaries using safe string splitting (NOT regex with raw user input):
     - Escape regex special characters in query
     - Split using `text.split(new RegExp('(' + escapedQuery + ')', 'gi'))`
     - Map parts: matching parts wrapped in `<mark className="bg-gold-light/50 text-foreground px-0.5 rounded-sm">`, non-matching as plain `<span>`
   - Use React key based on index (stable since text/query combination is deterministic)
   - Per research anti-pattern warning: do NOT use dangerouslySetInnerHTML
  </action>
  <verify>
- `npm install minisearch` completes successfully
- `src/hooks/use-provision-search.ts` exports `useProvisionSearch` and `useAllProvisionsForSearch`
- `src/components/ftc/provisions/HighlightText.tsx` renders highlighted text safely
- TypeScript compiles without new errors
  </verify>
  <done>
- MiniSearch installed as dependency
- Search hook builds index from provisions with composite IDs and supports scoped search
- All-provisions hook fetches all shards in parallel for cross-topic search with deduplication
- HighlightText component safely highlights matching terms without XSS risk
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate search into filter bar, add scope toggle, wire cross-topic search results</name>
  <files>
    src/components/ftc/provisions/ProvisionFilterBar.tsx
    src/components/ftc/provisions/SearchResults.tsx
    src/components/ftc/provisions/ProvisionsContent.tsx
    src/components/ftc/provisions/ProvisionCard.tsx
    src/components/ftc/FTCProvisionsTab.tsx
    src/hooks/use-provisions.ts
  </files>
  <action>
1. Update `ProvisionFilterBar.tsx` to add search input and scope toggle:
   - Add search input: `<input>` styled as `border border-rule px-3 py-1.5 text-sm font-garamond flex-1 min-w-[200px]` with Search icon (lucide-react)
   - Add scope toggle next to search: two small buttons "This topic" / "All topics" — styled like date preset toggle buttons
   - New props: `searchQuery: string`, `onSearchChange: (query: string) => void`, `searchScope: "topic" | "all"`, `onSearchScopeChange: (scope: "topic" | "all") => void`
   - Search input should debounce input (300ms) before triggering search — use a local state + useEffect with setTimeout for debounce

2. Update `ProvisionCard.tsx`:
   - Pass the `searchQuery` prop through to a `HighlightText` component for the verbatim_text display
   - When searchQuery is provided, wrap the verbatim text rendering with `<HighlightText text={provision.verbatim_text} query={searchQuery} />`
   - Also highlight in the title if searchQuery is present

3. Update `ProvisionsContent.tsx` to integrate in-topic search:
   - Add `searchQuery` state and `searchScope` state
   - When searchScope is "topic" and searchQuery is non-empty:
     - Use `useProvisionSearch(shardProvisions)` to get the search function
     - Apply search results as a filter: get matching provision IDs from search, then filter the provision list to only include those IDs
     - Apply search BEFORE other filters (date, company, remedy type) so filters further narrow search results
     - Pass searchQuery to ProvisionCard for highlighting
   - When searchScope is "all":
     - Lift the search to FTCProvisionsTab via a callback prop (e.g., `onCrossTopicSearch(query)`)
     - ProvisionsContent passes the callback up; FTCProvisionsTab handles cross-topic view
   - Update result count to show search result count
   - Add searchQuery to filter chips (as a "Search: {query}" chip that's dismissible)

4. Create `src/components/ftc/provisions/SearchResults.tsx`:
   - Props: `{ query: string; manifest: ProvisionsManifest; onSelectTopic: (topic: string) => void }`
   - Uses `useAllProvisionsForSearch()` to load all provision data
   - Uses `useProvisionSearch(allProvisions)` to search across everything
   - Shows loading state while shards are loading: "Loading provisions... ({loadedCount}/{totalCount} topics)"
   - Groups search results by topic (using the provision's statutory_topics/practice_areas to determine primary topic)
   - Display per user decision: "Data Security (12 results)", "COPPA (5 results)" — each topic group is clickable to navigate to that topic with the search query
   - Show total count header: "{N} matching provisions across {M} cases in {K} topics"
   - Shows top 5 results per topic with ProvisionCard (with search highlighting), plus a "View all {N} in {Topic}" link
   - For grouping: use the topic that the provision shard was loaded from (track shard origin in the flattened array)

5. Update `FTCProvisionsTab.tsx`:
   - Add `searchQuery` state and `searchScope` state at the tab level
   - When searchScope is "all" and searchQuery is non-empty, replace the content area with `<SearchResults>` component instead of ProvisionsContent
   - When user clicks a topic in search results, switch to that topic with the search query preserved
   - The search query should be stored in URL via `q` search param for shareability
  </action>
  <verify>
- Navigate to provisions tab, select a topic, type "security program" in search bar
- Verify matching provisions appear with "security program" highlighted in text
- Toggle to "All topics" — verify cross-topic results load (with loading indicator) and group by topic
- Click a topic in cross-topic results — navigate to that topic with search active
- Verify result counts are accurate
- Verify search query appears as a dismissible chip in filter bar
- Verify URL updates with `q=security+program` param
  </verify>
  <done>
- Full-text search works within current topic using MiniSearch (PROV-09)
- Search scope toggle switches between "This topic" and "All topics" (per user decision)
- Cross-topic results are grouped by topic with counts (per user decision)
- Matching terms are highlighted in provision text (per user decision)
- Total count of matching provisions and cases is displayed (PROV-10)
- Search query is persisted in URL for shareability
  </done>
</task>

</tasks>

<verification>
- Search "comprehensive security program" within COPPA topic — matching provisions highlighted
- Toggle to "All topics" — results from multiple topics appear grouped
- Cross-topic result counts are plausible (dozens of matches across topics)
- Click a topic group in results — navigates to that topic with search preserved
- Dismiss search chip — clears search and shows unfiltered provisions
- URL contains `q=` parameter when search is active
- All existing filters (date, company, remedy type) work in combination with search
</verification>

<success_criteria>
Legal practitioners can search across all provisions using text search, toggle between topic-scoped and cross-topic search, see highlighted matching terms, and view results grouped by topic with accurate counts.
</success_criteria>

<output>
After completion, create `.planning/phases/03-provisions-library/03-04-SUMMARY.md`
</output>
