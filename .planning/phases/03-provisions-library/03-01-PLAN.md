---
phase: 03-provisions-library
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build-provisions.ts
  - src/types/ftc.ts
  - public/data/provisions/manifest.json
  - public/data/provisions/rt-monetary-penalty-provisions.json
  - public/data/provisions/rt-data-deletion-provisions.json
  - public/data/provisions/rt-comprehensive-security-program-provisions.json
  - public/data/provisions/rt-third-party-assessment-provisions.json
  - public/data/provisions/rt-algorithmic-destruction-provisions.json
  - public/data/provisions/rt-biometric-ban-provisions.json
  - public/data/provisions/rt-compliance-monitoring-provisions.json
  - public/data/provisions/rt-recordkeeping-provisions.json
  - public/data/provisions/rt-prohibition-provisions.json
  - public/data/provisions/rt-other-provisions.json
autonomous: true
requirements:
  - PROV-02
  - PROV-03
  - PROV-04

must_haves:
  truths:
    - "Each provision record in shard files includes verbatim_text field with actual order language from source files"
    - "Each provision record includes violation_type field (deceptive/unfair/both)"
    - "Remedy-type shard files exist with rt- prefix for all 10 remedy types"
    - "A manifest.json file exists with provision counts per topic for sidebar display"
  artifacts:
    - path: "scripts/build-provisions.ts"
      provides: "Updated build pipeline with verbatim text, violation type, remedy shards, and manifest"
    - path: "src/types/ftc.ts"
      provides: "Extended ProvisionRecord with verbatim_text and violation_type fields"
      contains: "verbatim_text"
    - path: "public/data/provisions/manifest.json"
      provides: "Manifest with topic counts, shard filenames, and totals"
      contains: "total_provisions"
  key_links:
    - from: "scripts/build-provisions.ts"
      to: "public/data/ftc-files/*.json"
      via: "reads order.provisions[].requirements[].quoted_text"
      pattern: "requirements.*quoted_text"
    - from: "scripts/build-provisions.ts"
      to: "public/data/provisions/manifest.json"
      via: "writes manifest with topic counts"
      pattern: "manifest"
---

<objective>
Update the build pipeline to include verbatim order text and violation type in provision records, generate remedy-type shard files, and produce a manifest.json for the sidebar.

Purpose: The provisions library requires verbatim quoted order language (PROV-02), violation type per card (PROV-04), and remedy-type browsing with accurate sidebar counts (PROV-01). The current pipeline has a data gap: shards contain only AI-generated summaries, not the actual order text. This plan closes that gap and adds the missing data infrastructure.

Output: Updated build-provisions.ts, extended ProvisionRecord type, remedy-type shards, manifest.json
</objective>

<execution_context>
@C:/Users/rafst/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rafst/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-provisions-library/03-RESEARCH.md
@scripts/build-provisions.ts
@src/types/ftc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ProvisionRecord type and update build pipeline to include verbatim text, violation type, remedy-type shards, and manifest</name>
  <files>
    src/types/ftc.ts
    scripts/build-provisions.ts
  </files>
  <action>
1. In `src/types/ftc.ts`, extend the `ProvisionRecord` interface:
   - Add `verbatim_text: string` field (concatenation of all requirements[].quoted_text for the provision)
   - Add `violation_type: "deceptive" | "unfair" | "both" | ""` field (from case_info.violation_type)
   - Also add the same fields to the inline `ProvisionRecord` interface in `scripts/build-provisions.ts` (which uses inline types to avoid path alias issues)

2. In `scripts/build-provisions.ts`, update the main loop to populate the new fields:
   - For `verbatim_text`: Concatenate `provision.requirements[].quoted_text` joined by `"\n\n"`. If no requirements or no quoted_text, use empty string. Example: `const verbatimText = (provision.requirements || []).map((r: any) => r.quoted_text || "").filter(Boolean).join("\n\n");`
   - For `violation_type`: Read from `caseInfo.violation_type || ""` and add to each ProvisionRecord

3. Add remedy-type shard generation alongside existing topic and practice-area shards:
   - Create a `remedyTypeShards` Map similar to `topicShards` and `practiceAreaShards`
   - In the provision processing loop, iterate `record.remedy_types` and add the record to each remedy type slug (using `rt-` prefix for filenames)
   - If `remedy_types` is empty, add to `rt-other` shard
   - Write remedy-type shard files with filename pattern `rt-{slugified-remedy-type}-provisions.json`

4. After all shards are written, generate `public/data/provisions/manifest.json`:
   ```json
   {
     "generated_at": "ISO timestamp",
     "total_provisions": <unique provision count>,
     "total_cases": <unique case count>,
     "topics": {
       "coppa": { "count": N, "shard": "coppa-provisions.json", "category": "statutory" },
       "pa-privacy": { "count": N, "shard": "pa-privacy-provisions.json", "category": "practice_area" },
       "rt-monetary-penalty": { "count": N, "shard": "rt-monetary-penalty-provisions.json", "category": "remedy_type" },
       ...
     }
   }
   ```
   - Derive `total_cases` by collecting unique `case_id` values during processing
   - For topic category assignment: statutory topics (no prefix) get `"statutory"`, `pa-` prefix gets `"practice_area"`, `rt-` prefix gets `"remedy_type"`
   - Include human-readable `label` field in each topic entry (e.g., `"label": "COPPA"`, `"label": "Data Security"`)

5. Add a corresponding `ProvisionsManifest` type to `src/types/ftc.ts`:
   ```typescript
   export interface ManifestTopic {
     count: number;
     shard: string;
     category: "statutory" | "practice_area" | "remedy_type";
     label: string;
   }

   export interface ProvisionsManifest {
     generated_at: string;
     total_provisions: number;
     total_cases: number;
     topics: Record<string, ManifestTopic>;
   }
   ```
  </action>
  <verify>
Run `npm run build:provisions` and verify:
- No errors during build
- All existing 15 shard files still present in public/data/provisions/
- 10 new rt-* shard files created in public/data/provisions/
- manifest.json created in public/data/provisions/
- Spot-check one shard file to confirm `verbatim_text` and `violation_type` fields exist on provision records
- Spot-check manifest.json has correct structure with all 25 topics listed
  </verify>
  <done>
- ProvisionRecord type has verbatim_text and violation_type fields
- build-provisions.ts produces shards with verbatim text concatenated from requirements[].quoted_text
- build-provisions.ts produces 10 rt-* remedy-type shard files
- build-provisions.ts produces manifest.json with counts, shard filenames, labels, and categories for all 25 topics
- `npm run build:provisions` completes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Run build pipeline and verify output quality</name>
  <files>
    public/data/provisions/manifest.json
  </files>
  <action>
1. Run `npm run build:provisions` to regenerate all shard files with the updated pipeline

2. Verify output quality:
   - Read manifest.json and confirm all 25 topics are present (7 statutory + 8 practice area + 10 remedy type)
   - Confirm total_provisions and total_cases are plausible (expect ~2,783 provisions, ~293 cases)
   - Check that no remedy-type topic has 0 provisions (if any does, note it but keep the shard â€” small counts are acceptable)

3. Spot-check verbatim text quality:
   - Read 2-3 provision records from different shards
   - Confirm verbatim_text is actual order language (starts with legal phrasing like "IT IS ORDERED" or "Respondent shall"), not a paraphrase
   - Confirm verbatim_text is non-empty for the vast majority of provisions (research says 99.8% of requirements have quoted_text)

4. Verify file sizes are reasonable:
   - Largest shard (section-5-only or pa-privacy) should be 2-4 MB with verbatim text
   - manifest.json should be small (under 5 KB)

5. Stage and confirm all new and modified provision files are correct
  </action>
  <verify>
Run `npm run build:provisions` successfully. Verify manifest.json exists and has all 25 topics. Spot-check 2 shard files for verbatim_text presence and quality.
  </verify>
  <done>
- Build pipeline runs successfully with no errors
- All 25 shard files exist (15 existing + 10 new rt-* files)
- manifest.json accurately reflects provision counts per topic
- Verbatim text is present and contains actual order language
- File sizes are reasonable for on-demand loading
  </done>
</task>

</tasks>

<verification>
- `npm run build:provisions` exits with code 0
- `public/data/provisions/manifest.json` exists and contains valid JSON with 25 topic entries
- All 25 shard files exist in `public/data/provisions/`
- Provision records in shards contain `verbatim_text` and `violation_type` fields
- TypeScript compiles: `npx tsc --noEmit` passes (or at least no new errors)
</verification>

<success_criteria>
The build pipeline produces complete provision data with verbatim order language, violation types, remedy-type shards, and a manifest file. This data infrastructure supports all downstream UI plans.
</success_criteria>

<output>
After completion, create `.planning/phases/03-provisions-library/03-01-SUMMARY.md`
</output>
