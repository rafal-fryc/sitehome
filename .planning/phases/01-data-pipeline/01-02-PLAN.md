---
phase: 01-data-pipeline
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - scripts/classify-provisions.ts
autonomous: true
requirements:
  - PIPE-01
  - PIPE-02
  - PIPE-03
  - PIPE-04
  - PIPE-08

must_haves:
  truths:
    - "scripts/classify-provisions.ts exists and is a runnable TypeScript script"
    - "The script structures each case as a prompt and calls the Anthropic API (Sonnet model) for classification"
    - "Rule-based mappings (statutory topic from legal_authority, remedy type from provision.category) are passed as structured hints in each prompt, not used as the final answer"
    - "The LLM response is parsed into StatutoryTopic[], PracticeArea[], RemedyType[], IndustrySector[] and written into source files"
    - "Tags are written into source files atomically (write to .tmp, validate, rename)"
    - "The script skips already-classified files (idempotent) and reports progress per-case to stdout"
    - "Case-level statutory_topics are derived as the union of all provision-level statutory_topics"
    - "No classification logic is embedded in browser code"
    - "Industry sector is inferred from business_description (not company name alone), per locked CONTEXT.md decision"
  artifacts:
    - path: "scripts/classify-provisions.ts"
      provides: "LLM-powered classification agent script for tagging all 293 source files"
      min_lines: 150
      contains: "isAlreadyClassified"
    - path: "scripts/classify-provisions.ts"
      provides: "Safe atomic file write utility"
      contains: "writeJSONSafe"
    - path: "scripts/classify-provisions.ts"
      provides: "Structured hint builder that formats rule-based signals as context for the LLM prompt"
      contains: "buildClassificationPrompt"
    - path: "scripts/classify-provisions.ts"
      provides: "business_description passed into buildClassificationPrompt for accurate industry sector inference"
      contains: "business_description"
  key_links:
    - from: "scripts/classify-provisions.ts"
      to: "src/types/ftc.ts"
      via: "import type"
      pattern: "import.*from.*src/types/ftc"
    - from: "scripts/classify-provisions.ts"
      to: "public/data/ftc-files/"
      via: "readFileSync / writeJSONSafe"
      pattern: "writeJSONSafe|renameSync"
    - from: "scripts/classify-provisions.ts"
      to: "Anthropic API"
      via: "@anthropic-ai/sdk messages.create"
      pattern: "anthropic\\.messages\\.create|claude-sonnet"
---

<objective>
Write scripts/classify-provisions.ts — the one-time classification agent script that reads all 293 FTC case source files, invokes a Claude Sonnet model to classify each case, and writes statutory topic, practice area, remedy type, and industry sector tags back into the source files.

Purpose: Per CONTEXT.md locked decision, classification is powered by a Claude Code Sonnet agent, not rule-based keyword matching. Rule-based mappings (statutory topic from legal_authority string, remedy type from provision.category) are computed and included in each prompt as structured hints — they inform the LLM but the LLM makes the final classification decisions. Industry sector is inferred from the business_description field (per locked CONTEXT.md decision: "reads business_description alongside legal_authority and provisions"). This script must be idempotent (safe to re-run), atomic in file writes (no corruption risk), and clear about progress. Tags are written into source files so the build step reads pre-classified data — no classification logic ships to the browser (PIPE-08).

Output: scripts/classify-provisions.ts — a fully functional TypeScript script ready to be run as `npm run build:classify`.
</objective>

<execution_context>
@C:/Users/rafst/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rafst/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/ftc.ts
@scripts/build-ftc-data.ts
@.planning/phases/01-data-pipeline/01-RESEARCH.md
@.planning/phases/01-data-pipeline/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write classify-provisions.ts as a Sonnet-powered classification agent with rule-based hints</name>
  <files>scripts/classify-provisions.ts</files>
  <action>
    Create scripts/classify-provisions.ts as a TypeScript script (runs via `npx tsx scripts/classify-provisions.ts`). This script calls the Anthropic API using the `@anthropic-ai/sdk` package (install it: `npm install --save-dev @anthropic-ai/sdk`). Build it with the following components:

    **Imports:**
    - `@anthropic-ai/sdk` default import as Anthropic
    - Node.js built-ins: fs (readFileSync, writeFileSync, renameSync, readdirSync), path (join, resolve)
    - Type imports from '../src/types/ftc.js': StatutoryTopic, PracticeArea, RemedyType, IndustrySector, ClassifiedProvision, ClassifiedCaseInfo

    **SDK initialization:**
    ```typescript
    const anthropic = new Anthropic();
    // Uses ANTHROPIC_API_KEY env var automatically.
    // In Claude Code sessions (Max subscription), this is provided automatically.
    ```

    **Rule-based hint builders (these are INPUTS to the LLM, not final answers):**

    1. `deriveStatutoryTopicHints(legal_authority: string): string[]` — scans legal_authority for statute names:
       - Contains "COPPA" or "Children's Online Privacy Protection" → hint "COPPA"
       - Contains "FCRA" or "Fair Credit Reporting" → hint "FCRA"
       - Contains "GLBA" or "Gramm-Leach-Bliley" or "Financial Modernization" → hint "GLBA"
       - Contains "Health Breach Notification" → hint "Health Breach Notification"
       - Contains "CAN-SPAM" → hint "CAN-SPAM"
       - Contains "TCPA" or "Telephone Consumer Protection" → hint "TCPA"
       - Contains "Telemarketing Sales Rule" or "TSR" → hint "TSR"
       - If none match → hint "Section 5 Only"
       Returns array of string hints (NOT typed StatutoryTopic — these are hints for the prompt).

    2. `deriveRemedyTypeHints(category: string, title: string): string[]` — maps provision structural category to remedy hints:
       - category "assessment" → hint "Third-Party Assessment"
       - category "compliance_reporting" or "monitoring" → hint "Compliance Monitoring"
       - category "recordkeeping" or "acknowledgment" → hint "Recordkeeping"
       - category "prohibition" → check title: "facial recognition" | "biometric" → hint "Biometric Ban"; "algorithm" | "model destruction" → hint "Algorithmic Destruction"; otherwise → hint "Prohibition"
       - category "affirmative_obligation" → check title: "civil penalty" | "monetary" | "judgment" → hint "Monetary Penalty"; "deletion" | "dispose" | "destroy" → hint "Data Deletion"; "security program" | "information security" | "safeguard" → hint "Comprehensive Security Program"; otherwise → hint (leave empty, let LLM decide)
       - category "duration" → hint "Other"
       Returns array of string hints.

    **Prompt builder:**
    ```typescript
    function buildClassificationPrompt(
      caseData: unknown,
      businessDescription: string,
      statutoryHints: string[],
      provisionHints: Array<{provision_number: string, remedy_hints: string[]}>
    ): string
    ```
    Build a structured prompt that includes:
    - The case company name, date, and legal_authority (from caseData)
    - **Company business description: [businessDescription]** — include this immediately after the company name and legal_authority lines. This is the primary signal for industry sector inference. If empty, write "Not provided."
    - The full list of provisions (provision_number, title, category, summary for each)
    - The rule-based hints: "Based on the legal_authority field, rule-based analysis suggests these statutory topics: [hints]. Please verify and correct if needed."
    - The remedy hints per provision: "For provision [N] (category: [cat]), rule-based analysis suggests remedy type: [hint]. Please verify."
    - Ask the LLM to return a JSON object with this exact structure:
      ```json
      {
        "case_statutory_topics": ["COPPA"],
        "case_practice_areas": ["Privacy", "Data Security"],
        "case_industry_sectors": ["Technology"],
        "provisions": [
          {
            "provision_number": "I",
            "statutory_topics": ["COPPA"],
            "practice_areas": ["Privacy"],
            "remedy_types": ["Monetary Penalty"]
          }
        ]
      }
      ```
    - Include the valid enum values in the prompt for each field so the LLM knows the allowed values:
      - StatutoryTopics: COPPA, FCRA, GLBA, Health Breach Notification, CAN-SPAM, TCPA, TSR, Section 5 Only
      - PracticeAreas: Privacy, Data Security, Deceptive Design / Dark Patterns, AI / Automated Decision-Making, Surveillance, Financial Practices, Telemarketing, Other
      - RemedyTypes: Monetary Penalty, Data Deletion, Comprehensive Security Program, Third-Party Assessment, Algorithmic Destruction, Biometric Ban, Compliance Monitoring, Recordkeeping, Prohibition, Other
      - IndustrySectors: Technology, Healthcare, Financial Services, Retail, Telecom, Education, Social Media, Other
    - Instruct: "Return ONLY valid JSON matching the structure above. Do not include explanation. Use only the enum values listed. Multi-tag when multiple apply."

    **LLM call function:**
    ```typescript
    async function classifyWithLLM(prompt: string): Promise<ClassificationResult> {
      const response = await anthropic.messages.create({
        model: 'claude-sonnet-4-5',
        max_tokens: 2048,
        messages: [{ role: 'user', content: prompt }],
      });
      const text = response.content[0].type === 'text' ? response.content[0].text : '';
      // Strip markdown code fences if present (```json ... ```)
      const cleaned = text.replace(/^```json\s*/m, '').replace(/^```\s*$/m, '').trim();
      return JSON.parse(cleaned) as ClassificationResult;
    }
    ```
    Define `ClassificationResult` as a local interface matching the JSON structure above.

    **Apply classification to case data:**
    After receiving `ClassificationResult` from the LLM, merge the tags back into the case JSON object:
    - Set `caseData.case_info.statutory_topics = result.case_statutory_topics`
    - Set `caseData.case_info.practice_areas = result.case_practice_areas`
    - Set `caseData.case_info.industry_sectors = result.case_industry_sectors`
    - For each provision in `caseData.order.provisions`, find the matching provision_number in `result.provisions` and set `provision.statutory_topics`, `provision.practice_areas`, `provision.remedy_types`
    - Provisions with no matching entry in result.provisions default to empty arrays (log a warning)

    **Safe file write (CRITICAL — prevents source file corruption):**
    ```typescript
    function writeJSONSafe(filePath: string, data: unknown): void {
      const tmp = filePath + '.tmp';
      const serialized = JSON.stringify(data, null, 2);
      JSON.parse(serialized); // throws if invalid — validates before writing
      writeFileSync(tmp, serialized, 'utf-8');
      renameSync(tmp, filePath);
    }
    ```

    **Idempotency check:**
    ```typescript
    function isAlreadyClassified(caseData: unknown): boolean {
      return (caseData as any)?.case_info?.statutory_topics !== undefined;
    }
    ```

    **Main loop (async):**
    ```typescript
    const DATA_DIR = path.resolve('public/data/ftc-files');
    const files = readdirSync(DATA_DIR).filter(f => f.endsWith('.json')).sort();
    let classified = 0, skipped = 0, errors = 0;
    for (const filename of files) {
      const filePath = path.join(DATA_DIR, filename);
      try {
        const raw = readFileSync(filePath, 'utf-8');
        const data = JSON.parse(raw);
        if (isAlreadyClassified(data)) {
          console.log(`SKIP ${filename} (already classified)`);
          skipped++;
          continue;
        }
        // Extract business_description for industry sector inference (locked CONTEXT.md decision)
        const businessDescription = data.case_info?.business_description ?? '';
        // Build hints for this case
        const statutoryHints = deriveStatutoryTopicHints(data.case_info?.legal_authority ?? '');
        const provisionHints = (data.order?.provisions ?? []).map((p: any) => ({
          provision_number: p.provision_number,
          remedy_hints: deriveRemedyTypeHints(p.category ?? '', p.title ?? ''),
        }));
        const prompt = buildClassificationPrompt(data, businessDescription, statutoryHints, provisionHints);
        const result = await classifyWithLLM(prompt);
        const classified_data = applyClassification(data, result);
        writeJSONSafe(filePath, classified_data);
        console.log(`OK   ${filename} — topics: ${result.case_statutory_topics.join(', ')}`);
        classified++;
      } catch (err) {
        console.error(`ERR  ${filename}: ${err}`);
        errors++;
      }
    }
    console.log(`\nDone: ${classified} classified, ${skipped} skipped, ${errors} errors`);
    ```

    The script must compile type-safe against the interfaces from src/types/ftc.ts. Use explicit relative import with .js extension: `import type { StatutoryTopic, ... } from '../src/types/ftc.js';`

    Add a rate-limiting pause between API calls to avoid hitting rate limits:
    ```typescript
    await new Promise(resolve => setTimeout(resolve, 300)); // 300ms between calls
    ```

    Add `--dry-run` flag support: if `process.argv.includes('--dry-run')`, process only the first 3 files and print the prompts + parsed results without writing to disk. This allows testing the prompt structure before running the full batch.
  </action>
  <verify>
    1. `npm install --save-dev @anthropic-ai/sdk` (if not already installed)
    2. `npx tsc --noEmit` — zero TypeScript errors
    3. `npx tsx scripts/classify-provisions.ts --dry-run 2>&1` — should print the prompt for the first case file (including the business_description line) and the parsed LLM JSON response. Must NOT throw a TypeScript error. Requires ANTHROPIC_API_KEY to be set in the environment (available automatically in Claude Code sessions).
    4. Confirm `buildClassificationPrompt`, `isAlreadyClassified`, and `writeJSONSafe` functions exist in the file via grep.
    5. Confirm `business_description` appears in the file and is passed into `buildClassificationPrompt` via grep: `grep -n "business_description" scripts/classify-provisions.ts` — must show both extraction in the main loop and usage in the prompt body.
  </verify>
  <done>scripts/classify-provisions.ts exists, uses @anthropic-ai/sdk to call claude-sonnet-4-5, extracts business_description from case_info and passes it into buildClassificationPrompt (which includes it in the prompt immediately after company name and legal_authority), passes rule-based hints as prompt context, parses LLM JSON response, writes tags atomically, skips already-classified files, and supports --dry-run. npx tsc --noEmit passes with zero errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero errors
2. `npx tsx scripts/classify-provisions.ts --dry-run 2>&1 | head -50` — shows the structured prompt being built (business_description line visible) and the LLM response parsed for the first case
3. After dry-run: confirm no source files were modified (they should be unchanged)
4. grep `scripts/classify-provisions.ts` for "claude-sonnet" and "messages.create" — both must appear (confirms actual LLM calls, not rule-based fallback)
5. grep `scripts/classify-provisions.ts` for "buildClassificationPrompt" and "writeJSONSafe" and "isAlreadyClassified" — all three must appear
6. grep `scripts/classify-provisions.ts` for "business_description" — must appear in both the main loop (extraction) and the prompt body (inclusion)
</verification>

<success_criteria>
scripts/classify-provisions.ts:
- Calls Anthropic API (claude-sonnet-4-5) for each case via @anthropic-ai/sdk
- Extracts business_description from case_info and passes it to buildClassificationPrompt (PIPE-04 / locked CONTEXT.md decision satisfied)
- Builds structured prompts that include business_description immediately after company name and legal_authority, enabling accurate industry sector inference
- Builds structured prompts that include rule-based hints as LLM context (not as final classification)
- Parses LLM JSON response and writes statutory_topics, practice_areas, industry_sectors, remedy_types tags into source files
- Atomic file writes (tmp + rename)
- Idempotent — skips already-classified files
- Supports --dry-run flag for testing
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-pipeline/01-02-SUMMARY.md`
</output>
