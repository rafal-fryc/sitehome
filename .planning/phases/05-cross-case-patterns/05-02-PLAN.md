---
phase: 05-cross-case-patterns
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/hooks/use-patterns.ts
  - src/components/ftc/FTCPatternsTab.tsx
  - src/components/ftc/patterns/PatternList.tsx
  - src/components/ftc/patterns/PatternRow.tsx
  - src/components/ftc/patterns/PatternTimeline.tsx
  - src/components/ftc/patterns/VariantCard.tsx
  - src/components/ftc/patterns/TextDiff.tsx
autonomous: true
requirements: [PATN-02, PATN-03]

must_haves:
  truths:
    - "User can see a sorted list of named pattern groups with case count, date span, and Structural badge"
    - "Clicking a pattern row expands a chronological vertical timeline of variant cards below it"
    - "Each variant card shows truncated provision text with case context (company, year, docket) expandable to full text"
    - "Consecutive variants on the timeline show word-level diff highlighting of text changes"
    - "User can search patterns by name and filter by enforcement topic"
    - "Structural patterns have a visible Structural badge and are always visible (not hidden or separated)"
    - "Default sort is by recency (most recently appearing patterns first)"
  artifacts:
    - path: "src/hooks/use-patterns.ts"
      provides: "usePatterns() React Query hook for ftc-patterns.json"
      exports: ["usePatterns"]
    - path: "src/components/ftc/FTCPatternsTab.tsx"
      provides: "Root patterns tab component replacing placeholder"
      min_lines: 15
    - path: "src/components/ftc/patterns/PatternList.tsx"
      provides: "Pattern list with search, filter, sort, and expansion state"
      min_lines: 60
    - path: "src/components/ftc/patterns/PatternRow.tsx"
      provides: "Single pattern row with name, count, date span, structural badge"
      min_lines: 25
    - path: "src/components/ftc/patterns/PatternTimeline.tsx"
      provides: "Vertical chronological timeline of provision variants"
      min_lines: 30
    - path: "src/components/ftc/patterns/VariantCard.tsx"
      provides: "Variant card with text preview, expand/collapse, case context"
      min_lines: 40
    - path: "src/components/ftc/patterns/TextDiff.tsx"
      provides: "Word-level diff highlighting between two texts using jsdiff"
      min_lines: 20
  key_links:
    - from: "src/hooks/use-patterns.ts"
      to: "/data/ftc-patterns.json"
      via: "fetch with React Query"
      pattern: "fetch.*ftc-patterns"
    - from: "src/components/ftc/FTCPatternsTab.tsx"
      to: "src/hooks/use-patterns.ts"
      via: "usePatterns() hook call"
      pattern: "usePatterns"
    - from: "src/components/ftc/patterns/PatternList.tsx"
      to: "src/components/ftc/patterns/PatternRow.tsx"
      via: "renders rows with expansion state"
      pattern: "PatternRow"
    - from: "src/components/ftc/patterns/PatternRow.tsx"
      to: "src/components/ftc/patterns/PatternTimeline.tsx"
      via: "renders timeline when expanded"
      pattern: "PatternTimeline"
    - from: "src/components/ftc/patterns/PatternTimeline.tsx"
      to: "src/components/ftc/patterns/VariantCard.tsx"
      via: "renders variant cards along timeline"
      pattern: "VariantCard"
    - from: "src/components/ftc/patterns/VariantCard.tsx"
      to: "src/components/ftc/patterns/TextDiff.tsx"
      via: "renders diff when variant has previous text"
      pattern: "TextDiff"
---

<objective>
Build the complete Patterns tab UI: a filterable pattern list with inline-expandable chronological timelines, variant cards with word-level diff highlighting, and structural badges.

Purpose: PATN-02 (view pattern groups showing provision language across cases) and PATN-03 (chronological timeline with language evolution) are the core user-facing deliverables of Phase 5.

Output: `usePatterns` hook, `FTCPatternsTab` (replaces placeholder), and 5 pattern components in `src/components/ftc/patterns/`
</objective>

<execution_context>
@C:/Users/rafst/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rafst/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-cross-case-patterns/05-RESEARCH.md
@.planning/phases/05-cross-case-patterns/05-CONTEXT.md
@.planning/phases/05-cross-case-patterns/05-01-SUMMARY.md
@.planning/phases/03-provisions-library/03-02-SUMMARY.md

@src/types/ftc.ts
@src/hooks/use-provisions.ts
@src/components/ftc/FTCPatternsTab.tsx
@src/components/ftc/provisions/ProvisionCard.tsx
@src/components/ftc/provisions/TopicSidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install diff package, create usePatterns hook, TextDiff, and VariantCard components</name>
  <files>
    src/hooks/use-patterns.ts
    src/components/ftc/patterns/TextDiff.tsx
    src/components/ftc/patterns/VariantCard.tsx
  </files>
  <action>
**0. Install the diff (jsdiff) package:**
Run `npm install diff` and `npm install -D @types/diff` (check if @types/diff is needed — jsdiff v8+ may ship its own types; install @types/diff only if import fails without it).

**1. Create src/hooks/use-patterns.ts** following the exact pattern from use-provisions.ts:

```typescript
import { useQuery } from "@tanstack/react-query";
import type { PatternsFile } from "@/types/ftc";

export function usePatterns() {
  return useQuery<PatternsFile>({
    queryKey: ["ftc-patterns"],
    queryFn: async () => {
      const res = await fetch("/data/ftc-patterns.json");
      if (!res.ok) throw new Error("Failed to load patterns data");
      return res.json();
    },
    staleTime: Infinity,
  });
}
```

**2. Create src/components/ftc/patterns/TextDiff.tsx:**

Word-level diff highlighting using `diffWords()` from the `diff` package. This component receives `oldText` and `newText` props and renders inline spans with green background for additions and red strikethrough for removals.

- Use `useMemo` with `[oldText, newText]` dependencies to avoid recomputing diffs on every render (per research Pitfall 2).
- Styling: `bg-green-100/60 text-green-900 no-underline` for additions (ins element), `bg-red-100/60 text-red-900 line-through` for removals (del element). Unchanged text in plain spans.
- Wrap in `span` with `whitespace-pre-line font-garamond leading-relaxed` to match law-library aesthetic.
- See 05-RESEARCH.md "Pattern 4: Word-Level Diff Highlighting" for exact implementation.

**3. Create src/components/ftc/patterns/VariantCard.tsx:**

Each variant card shows a provision's text with case context on the timeline.

Props: `variant: PatternVariant`, `previousText: string | null` (the verbatim_text of the previous variant in the timeline for diff comparison), `isFirst: boolean`.

Layout (within a card-style container `p-4 bg-cream border border-rule`):
- **Header row:** Company name (bold), year, docket number, and if `ftc_url` exists, a small "View on FTC.gov" external link icon (lucide ExternalLink).
- **Text area:**
  - If both `previousText` and `variant.verbatim_text` are non-empty and the variant is not the first, show a toggle "Show changes" / "Show full text". Default state: show full text (not diff) to avoid performance issues with many expanded variants.
  - When "Show changes" is active, render `<TextDiff oldText={previousText} newText={variant.verbatim_text} />`.
  - When "Show full text" is active (default), render `variant.verbatim_text` or `variant.text_preview` with `whitespace-pre-line`.
- **Expand/collapse:** If `verbatim_text` is non-empty and longer than `text_preview`, show text_preview by default with a "Show full text" / "Show less" toggle button (text button, not a big CTA). If `verbatim_text` is empty (truncated for large patterns), show only `text_preview` with a note "(preview only)".
- Use `font-garamond` for provision text to match the provisions library aesthetic.
  </action>
  <verify>
1. `npm ls diff` confirms diff package is installed
2. `npx tsc --noEmit` passes
3. TextDiff.tsx exports a default function component
4. VariantCard.tsx exports a default function component with proper Props interface
  </verify>
  <done>
usePatterns hook fetches ftc-patterns.json via React Query with staleTime: Infinity. TextDiff renders word-level diff highlighting using jsdiff diffWords(). VariantCard shows provision text with case context header, expand/collapse for long text, and optional diff toggle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PatternTimeline, PatternRow, PatternList, and wire FTCPatternsTab</name>
  <files>
    src/components/ftc/patterns/PatternTimeline.tsx
    src/components/ftc/patterns/PatternRow.tsx
    src/components/ftc/patterns/PatternList.tsx
    src/components/ftc/FTCPatternsTab.tsx
  </files>
  <action>
**1. Create src/components/ftc/patterns/PatternTimeline.tsx:**

Vertical timeline component showing chronological variant cards.

Props: `variants: PatternVariant[]` (already sorted ascending by date_issued from build pipeline).

Layout:
- A `div` with `relative pl-8 border-l-2 border-rule ml-4 py-4` for the vertical timeline line.
- Each variant gets a timeline dot: `absolute -left-[calc(2rem+5px)] top-1 w-3 h-3 rounded-full bg-gold border-2 border-cream` positioned on the timeline line.
- Year label above each variant card: `text-xs text-muted-foreground font-semibold uppercase tracking-wide`.
- Render a `VariantCard` for each variant, passing `previousText` from the prior variant's `verbatim_text` (null for the first variant), and `isFirst` boolean.
- **Pagination for large timelines:** If variants.length > 15, show the first 15 with a "Show all {N} variants" button at the bottom. Use local useState for expansion.
- Key each variant by `${variant.case_id}__${variant.provision_number}`.

**2. Create src/components/ftc/patterns/PatternRow.tsx:**

A single row in the pattern list that can be clicked to expand/collapse the timeline.

Props: `pattern: PatternGroup`, `isExpanded: boolean`, `onToggle: () => void`.

Layout (clickable div with `cursor-pointer hover:bg-cream/50 transition-colors border-b border-rule py-3 px-4`):
- **Left side:** Pattern name (`font-garamond font-semibold text-primary`), and if `is_structural`, a small Badge with text "Structural" (`bg-muted text-muted-foreground text-xs`).
- **Right side (flex row):** Case count (`{pattern.case_count} cases`), date span (`{year_range[0]}–{year_range[1]}`), and a ChevronDown/ChevronUp icon (lucide) indicating expand state.
- Below the row, when `isExpanded`, render `<PatternTimeline variants={pattern.variants} />` with a slide-down appearance (use Radix Collapsible from shadcn/ui for smooth animation, or simple conditional rendering — per research, Radix Collapsible is already available in the project).

**3. Create src/components/ftc/patterns/PatternList.tsx:**

The main pattern browser component with search, filter, sort controls and the list of PatternRow components.

Props: `patterns: PatternGroup[]` (from the PatternsFile loaded by the parent).

State:
- `expandedPatternId: string | null` — which pattern is currently expanded (only one at a time per user decision: inline expand)
- `searchQuery: string` — filters pattern list by name
- `topicFilter: string` — filters by enforcement_topics (empty = all)
- `sortBy: "recency" | "cases" | "name"` — default "recency" (most_recent_year desc)

Layout:
- **Header bar:**
  - Search input (shadcn Input with Search icon from lucide) for filtering pattern names.
  - Topic filter: a Select dropdown (shadcn Select) populated from the unique enforcement_topics across all patterns. Include "All Topics" as the default option.
  - Sort dropdown (shadcn Select): "Most Recent" (default), "Most Cases", "Alphabetical".
- **Summary line:** "{N} patterns found" (after filtering).
- **Pattern list:** Render filtered+sorted patterns as PatternRow components. Each row receives `isExpanded` and `onToggle` props.

Filtering logic:
- Search: case-insensitive substring match on `pattern.name`.
- Topic: if topicFilter is set, only show patterns where `enforcement_topics` includes the selected topic.
- Both filters compose (AND logic).

Sorting:
- "recency": sort by `most_recent_year` descending, then `case_count` descending as tiebreaker.
- "cases": sort by `case_count` descending.
- "name": sort alphabetically by `name`.

Use `useMemo` for the filtered+sorted list to avoid recomputation.

**4. Replace src/components/ftc/FTCPatternsTab.tsx:**

Replace the placeholder with the real patterns tab.

- Call `usePatterns()` to load the data.
- Handle loading state: show a centered spinner or "Loading patterns..." text.
- Handle error state: show "Failed to load patterns data." text.
- When data is loaded, render `<PatternList patterns={data.patterns} />`.
- Include a small summary header above the list: "Cross-Case Patterns" heading with a subtitle showing total pattern count and total variant count from the PatternsFile metadata.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` (vite build) completes without errors
3. Open `http://localhost:5173/FTCAnalytics?tab=patterns` in the dev server and verify:
   - Pattern list renders with pattern names, case counts, date spans
   - Structural badges appear on structural patterns
   - Search filters the list by pattern name
   - Topic filter narrows to patterns with matching enforcement topics
   - Clicking a pattern row expands the timeline below it
   - Timeline shows chronological variant cards with year labels and timeline dots
   - Variant cards show text preview, expand to full text, and offer diff toggle
  </verify>
  <done>
FTCPatternsTab loads ftc-patterns.json via usePatterns() hook and renders a filterable, sortable pattern list. Clicking a pattern row inline-expands a chronological vertical timeline with variant cards. Each variant card shows provision text with case context, expand/collapse for full text, and a "Show changes" toggle for word-level diff highlighting between consecutive variants. Structural patterns display a "Structural" badge.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors (TypeScript + Vite)
2. Patterns tab at `?tab=patterns` shows the full pattern browser replacing the "Coming Soon" placeholder
3. Pattern list displays 100+ named patterns with case counts and date spans
4. Structural patterns have a visible "Structural" badge
5. Search filters patterns by name in real time
6. Topic filter narrows patterns to those with matching enforcement topics
7. Clicking a pattern expands a chronological timeline below the row
8. Variant cards show case context (company, year, docket) and provision text
9. "Show changes" toggle renders word-level diff highlighting between consecutive variants
10. Default sort is by recency (most recently appearing patterns first)
</verification>

<success_criteria>
- PATN-02: User can view pattern groups showing how specific provision language appears across multiple cases — satisfied by the pattern list with inline-expandable timelines
- PATN-03: Pattern timeline shows chronological evolution of recurring provision language — satisfied by the vertical timeline with variant cards, year markers, and diff highlighting
- All locked decisions from CONTEXT.md are honored: vertical timeline layout, variant cards with expandable text, diff highlighting, sorted vertical list, inline expand, search box + topic filter, structural badge always visible, default sort by recency
</success_criteria>

<output>
After completion, create `.planning/phases/05-cross-case-patterns/05-02-SUMMARY.md`
</output>
