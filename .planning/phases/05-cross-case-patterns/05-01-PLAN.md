---
phase: 05-cross-case-patterns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build-patterns.ts
  - src/types/ftc.ts
  - package.json
  - public/data/ftc-patterns.json
autonomous: true
requirements: [PATN-01, PATN-04]

must_haves:
  truths:
    - "Running npm run build:patterns produces a valid ftc-patterns.json file in public/data/"
    - "Each pattern group has 3+ unique cases and a human-friendly pattern name"
    - "Structural patterns are correctly classified with is_structural: true based on provision category field"
    - "Near-identical provision titles are merged into the same pattern group via normalization + prefix merge"
    - "Pattern variants are sorted chronologically (ascending by date_issued)"
  artifacts:
    - path: "scripts/build-patterns.ts"
      provides: "Pattern detection build pipeline"
      min_lines: 150
    - path: "src/types/ftc.ts"
      provides: "PatternVariant, PatternGroup, PatternsFile interfaces"
      contains: "PatternGroup"
    - path: "public/data/ftc-patterns.json"
      provides: "Pre-computed pattern groups with variants"
      contains: "total_patterns"
    - path: "package.json"
      provides: "build:patterns npm script"
      contains: "build:patterns"
  key_links:
    - from: "scripts/build-patterns.ts"
      to: "public/data/provisions/*-provisions.json"
      via: "reads all statutory provision shards as input"
      pattern: "readFileSync.*provisions"
    - from: "scripts/build-patterns.ts"
      to: "public/data/ftc-patterns.json"
      via: "writeJSONSafe output"
      pattern: "writeJSONSafe.*ftc-patterns"
    - from: "src/types/ftc.ts"
      to: "PatternsFile"
      via: "exported interface used by UI hook"
      pattern: "export interface PatternsFile"
---

<objective>
Build the pattern detection pipeline that reads existing provision shard files, groups provisions by normalized title, classifies structural vs. substantive patterns, assigns human-friendly names, and outputs a static ftc-patterns.json file.

Purpose: PATN-01 (detect identical/near-identical provisions across cases) and PATN-04 (classify structural/boilerplate provisions) are satisfied entirely at build time. This pipeline must run before any UI work begins.

Output: `scripts/build-patterns.ts`, TypeScript interfaces in `src/types/ftc.ts`, `public/data/ftc-patterns.json`, npm script in `package.json`
</objective>

<execution_context>
@C:/Users/rafst/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/rafst/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-cross-case-patterns/05-RESEARCH.md
@.planning/phases/05-cross-case-patterns/05-CONTEXT.md
@.planning/phases/01-data-pipeline/01-03-SUMMARY.md

@scripts/build-provisions.ts
@src/types/ftc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TypeScript interfaces and create build-patterns.ts pipeline</name>
  <files>
    src/types/ftc.ts
    scripts/build-patterns.ts
    package.json
  </files>
  <action>
**1. Add TypeScript interfaces to src/types/ftc.ts** (append after ProvisionsManifest):

```typescript
// Phase 5: Cross-Case Patterns — Pattern data types

export interface PatternVariant {
  case_id: string;
  company_name: string;
  date_issued: string;
  year: number;
  provision_number: string;
  title: string;
  text_preview: string;
  verbatim_text: string;
  docket_number: string;
  ftc_url?: string;
  administration: string;
}

export interface PatternGroup {
  id: string;
  name: string;
  is_structural: boolean;
  case_count: number;
  variant_count: number;
  year_range: [number, number];
  most_recent_year: number;
  enforcement_topics: string[];
  practice_areas: string[];
  variants: PatternVariant[];
}

export interface PatternsFile {
  generated_at: string;
  total_patterns: number;
  total_variants: number;
  patterns: PatternGroup[];
}
```

**2. Create scripts/build-patterns.ts** following the established build-provisions.ts pattern (inline types to avoid tsx path alias issues):

Core algorithm:
- Read ALL statutory topic provision shard files from `public/data/provisions/` (files matching `*-provisions.json` but NOT `pa-*` or `rt-*` prefixes — statutory shards only to avoid double-counting provisions that appear in multiple shard types)
- Deduplicate provisions by composite key `${case_id}__${provision_number}` before grouping
- **Pass 1 — Exact normalized grouping:** For each provision, compute `normalizeForGrouping(title)` (lowercase, normalize dashes to spaces, strip punctuation, collapse whitespace, trim). Group provisions by this normalized key.
- **Pass 2 — Prefix merge for orphans:** Sort groups by case count descending. For groups with fewer than 3 unique cases, check if their normalized title starts with another group's normalized title (where the larger group has 3+ cases and the prefix is at least 3 words). If so, merge the smaller group into the larger one. This handles "Prohibition Against Misrepresentations About Privacy and Security" being absorbed into the "Prohibition Against Misrepresentations" parent family.
- **Filter:** Keep only groups with 3+ unique cases (per locked user decision).
- **Structural classification:** A pattern is structural if >50% of its provisions have a category in the set: `compliance_reporting`, `acknowledgment`, `recordkeeping`, `monitoring`, `duration`. Use the existing `category` field on ProvisionRecord (per research — this field already has high-accuracy classification).
- **Pattern naming:** Use the most common original (non-normalized) title variant in the group as the pattern name. This is already human-readable since it comes from the LLM classification in Phase 1.
- **Pattern ID:** Slugify the pattern name (lowercase, spaces/special chars to dashes).
- **Build PatternVariant objects** for each provision in each group. Include `text_preview` (first 300 chars of `verbatim_text`). Include full `verbatim_text` for patterns with <= 30 variants. For patterns with 30+ variants, include full `verbatim_text` only for the 30 most recent variants; set `verbatim_text` to empty string for older ones (the text_preview still covers them).
- **Collect enforcement_topics** (unique statutory_topics across all variants) and **practice_areas** (unique practice_areas across all variants) per pattern group.
- Sort variants within each group by `date_issued` ascending (chronological for timeline).
- Sort pattern groups by `most_recent_year` descending (default recency sort per user decision).
- Output `PatternsFile` JSON to `public/data/ftc-patterns.json` using the `writeJSONSafe` pattern.
- Print a summary report: total patterns, structural vs substantive breakdown, top 10 patterns by case count, output file size.

**3. Add npm script to package.json:**
Add `"build:patterns": "npx tsx scripts/build-patterns.ts"` to the scripts section.
Update `"build:data"` to include patterns: `"npm run build:ftc-data && npm run build:provisions && npm run build:patterns"`.
  </action>
  <verify>
Run `npm run build:patterns` and confirm:
1. No errors in console output
2. `public/data/ftc-patterns.json` is created and is valid JSON
3. The output contains a `total_patterns` field showing 100+ patterns (research found 126 at the 3+ threshold)
4. At least some patterns have `is_structural: true`
5. Each pattern has `variants` array sorted by date_issued ascending
6. `npx tsc --noEmit` passes (TypeScript types are correct)
  </verify>
  <done>
build-patterns.ts reads provision shards, produces ftc-patterns.json with 100+ pattern groups, each having 3+ cases. Structural patterns are labeled. Near-identical titles are merged via normalization + prefix merge. File size is logged in console output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run pipeline and validate output quality</name>
  <files>
    public/data/ftc-patterns.json
  </files>
  <action>
Run `npm run build:patterns` and perform quality validation:

1. **File size check:** Verify ftc-patterns.json is reasonable (expected 500KB-3MB based on research estimates). If over 3MB, report the size but do not fail — the text_preview truncation should keep it manageable.

2. **Distribution check:** Count structural vs substantive patterns. Research found ~39 structural and ~87 substantive. The actual numbers may differ slightly but the ratio should be roughly 30-40% structural.

3. **Top patterns spot-check:** Log the top 10 patterns by case count. Expected patterns include:
   - Compliance reporting patterns (Recordkeeping, Duration of Order, etc.) — should be structural
   - "Comprehensive Information Security Program" or similar — should be substantive
   - "Prohibition Against Misrepresentations" — should be substantive

4. **Variant sorting check:** For the top 3 patterns, verify variants are sorted by date_issued ascending (earliest first).

5. **Near-match merge check:** Verify that the "Prohibition Against Misrepresentations" family has merged orphan variants (small groups with fewer than 3 cases should have been absorbed into the main group).

6. **enforcement_topics and practice_areas check:** Verify at least some patterns have non-empty enforcement_topics and practice_areas arrays.

If any quality issue is found, fix build-patterns.ts and re-run. The goal is a clean, validated output file that the UI can consume directly.
  </action>
  <verify>
Run `npm run build:patterns` and visually inspect the console output. Then read the first 50 lines of ftc-patterns.json to confirm valid structure. Check that `total_patterns` >= 100 and `total_variants` >= 500.
  </verify>
  <done>
ftc-patterns.json passes all quality checks: correct pattern count range, structural/substantive split is reasonable, variants are chronologically sorted, near-match merging works correctly, file size is acceptable.
  </done>
</task>

</tasks>

<verification>
1. `npm run build:patterns` completes without errors
2. `public/data/ftc-patterns.json` exists and is valid JSON with `total_patterns` >= 100
3. Patterns with `is_structural: true` exist and match the structural category set
4. `npx tsc --noEmit` passes (TypeScript interfaces in ftc.ts are valid)
5. `package.json` has `build:patterns` script and updated `build:data` chain
</verification>

<success_criteria>
- PIPE-06 (deferred from Phase 1) is fulfilled: ftc-patterns.json is produced by the build pipeline
- PATN-01: Provisions with identical/near-identical titles across different consent orders are detected and grouped
- PATN-04: Structural/boilerplate provisions are classified using the category field majority vote and labeled with is_structural: true
- All pattern groups have 3+ unique cases per the locked user decision
- Near-match grouping correctly merges orphan variants via prefix merge
</success_criteria>

<output>
After completion, create `.planning/phases/05-cross-case-patterns/05-01-SUMMARY.md`
</output>
